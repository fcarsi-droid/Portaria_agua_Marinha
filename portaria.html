<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portaria √Ågua Marinha</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --navy: #1e293b; 
            --navy-dark: #0f172a; 
            --blue-action: #00b4d8; 
            --green-success: #22c55e; 
            --bg-gray: #f8fafc;
        }
        
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-gray); 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: #334155;
        }

        .card { 
            background: white; 
            border: 2px solid #e2e8f0; 
            padding: 24px; 
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); 
            width: 100%; 
            max-width: 450px; 
            margin-bottom: 20px; 
        }

        h1, h2 { 
            text-transform: uppercase; 
            letter-spacing: -0.025em;
            font-weight: 800;
            margin-top: 0; 
            color: var(--navy);
            font-style: italic;
        }

        label { 
            display: block; 
            margin-top: 15px; 
            font-size: 0.75rem; 
            font-weight: 700;
            text-transform: uppercase; 
            color: #64748b;
        }

        select, input { 
            width: 100%; 
            padding: 12px; 
            margin-top: 5px; 
            border: 1px solid #cbd5e1; 
            border-radius: 8px;
            font-size: 1rem;
            background-color: #fff;
        }

        /* O NOVO BOT√ÉO PROFISSIONAL */
        .btn-principal {
            width: 100%;
            background-color: var(--navy);
            color: white;
            padding: 18px;
            margin-top: 25px;
            border: none;
            border-bottom: 4px solid #020617;
            border-radius: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-principal:hover { background-color: var(--navy-dark); }
        .btn-principal:active { border-bottom-width: 0; transform: translateY(4px); }

        .item-pendente { 
            border-bottom: 1px solid #f1f5f9; 
            padding: 12px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .btn-baixa { 
            background: var(--green-success); 
            color: white; 
            border: none; 
            padding: 8px 12px; 
            border-radius: 6px; 
            font-weight: bold; 
            font-size: 0.7rem; 
            cursor: pointer;
        }

        .hidden { display: none !important; }
        
        #login-screen { text-align: center; }
    </style>
</head>
<body>

    <div id="login-screen" class="card hidden">
        <h1>Acesso Restrito</h1>
        <p style="color: #64748b;">Digite a credencial de seguran√ßa:</p>
        <input type="password" id="senha-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <button class="btn-principal" onclick="verificarSenha()">Entrar no Sistema</button>
    </div>

    <div id="visao-morador" class="card hidden">
        <h1 id="titulo-morador">Confirmar Retirada</h1>
        <p id="detalhe-encomenda" style="margin: 20px 0; line-height: 1.5;">Buscando detalhes...</p>
        <button id="btn-confirmar" class="btn-principal" style="background: var(--green-success); border-color: #166534;" onclick="confirmarPeloMorador()">
            üì¶ CONFIRMAR RECEBIMENTO
        </button>
    </div>

    <div id="visao-porteiro" class="hidden">
        <div class="card">
            <h1>üì¶ Registro de Entrada</h1>
            <label>Bloco</label>
            <select id="bloco" onchange="filtrarApartamentos()"><option>Carregando...</option></select>
            
            <label>Apartamento / Morador</label>
            <select id="apartamento"><option>Selecione o Bloco...</option></select>
            
            <label>Volumes Recebidos</label>
            <input type="number" id="qtd" value="1" min="1">
            
            <button class="btn-principal" onclick="registrar()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 14.933a.615.615 0 0 0 .1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067v13.866zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.159 7.159 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.158 7.158 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z"/>
                </svg>
                CONFIRMAR REGISTRO E ENVIAR ALERTA
            </button>
        </div>

        <div class="card">
            <h2>üöö Aguardando Retirada</h2>
            <div id="lista-pendentes" style="margin-top: 15px;">Carregando...</div>
            
            <button style="background: var(--blue-action); margin-top: 30px; border-bottom: 4px solid #0077b6;" class="btn-principal" onclick="exportarDados()">üìä Gerar Relat√≥rio CSV</button>
            <button style="background: #94a3b8; margin-top: 10px; font-size: 0.6em; border-bottom: 2px solid #475569;" class="btn-principal" onclick="logout()">Sair / Bloquear Sistema</button>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://esegzalccqvoypdpencs.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_kuJIAQ5crRqZlNO5spRdJQ__G9QLrjI';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const SENHA_MESTRA = "RDEAM2026#";

    const urlParams = new URLSearchParams(window.location.search);
    const encomendaId = urlParams.get('id');

    async function inicializar() {
        if (encomendaId) {
            exibirVisaoMorador();
        } else {
            verificarSessao();
        }
    }

    function verificarSessao() {
        if (localStorage.getItem('portaria_logado') === 'true') {
            exibirVisaoPorteiro();
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
        }
    }

    function verificarSenha() {
        const input = document.getElementById('senha-input').value;
        if (input === SENHA_MESTRA) {
            localStorage.setItem('portaria_logado', 'true');
            location.reload();
        } else {
            alert("Senha incorreta!");
        }
    }

    function logout() {
        localStorage.removeItem('portaria_logado');
        location.reload();
    }

    async function exibirVisaoPorteiro() {
        document.getElementById('visao-porteiro').classList.remove('hidden');
        await carregarMoradores();
        await carregarPendencias();
    }

    async function exibirVisaoMorador() {
        document.getElementById('visao-morador').classList.remove('hidden');
        const { data } = await supabaseClient.from('encomendas').select('quantidade, status, moradores(nome, bloco, apartamento)').eq('id', encomendaId).single();
        
        if (data) {
            if (data.status === 'ENTREGUE') {
                document.getElementById('visao-morador').innerHTML = "<h1>‚úÖ J√° Entregue</h1><p>Esta encomenda j√° consta como retirada no sistema.</p>";
            } else {
                document.getElementById('detalhe-encomenda').innerHTML = `Prezado(a) <b>${data.moradores.nome}</b>,<br>Confirme a retirada de <b>${data.quantidade} volume(s)</b><br>Unidade: Bloco ${data.moradores.bloco} - Apto ${data.moradores.apartamento}.`;
            }
        }
    }

    async function confirmarPeloMorador() {
        const { error } = await supabaseClient.from('encomendas').update({ status: 'ENTREGUE' }).eq('id', encomendaId);
        if (!error) {
            document.getElementById('visao-morador').innerHTML = "<h1 style='color:var(--green-success)'>‚úÖ SUCESSO!</h1><p>Sua retirada foi registrada com sucesso. Obrigado!</p>";
        } else {
            alert("Erro ao confirmar. Tente novamente.");
        }
    }

    async function carregarMoradores() {
        const { data } = await supabaseClient.from('moradores').select('*').order('bloco').order('apartamento');
        window.moradoresGlobal = data;
        const blocos = [...new Set(data.map(m => m.bloco))];
        const select = document.getElementById('bloco');
        select.innerHTML = '<option value="">Selecione o Bloco</option>';
        blocos.forEach(b => select.innerHTML += `<option value="${b}">Bloco ${b}</option>`);
    }

    function filtrarApartamentos() {
        const bloco = document.getElementById('bloco').value;
        const select = document.getElementById('apartamento');
        select.innerHTML = '<option value="">Selecione o Apartamento</option>';
        window.moradoresGlobal.filter(m => m.bloco === bloco).forEach(m => {
            select.innerHTML += `<option value="${m.id}">${m.apartamento} - ${m.nome}</option>`;
        });
    }

    async function carregarPendencias() {
        const { data } = await supabaseClient.from('encomendas').select('id, quantidade, criado_em, moradores(nome, bloco, apartamento)').eq('status', 'DISPON√çVEL').order('criado_em', { ascending: false });
        const container = document.getElementById('lista-pendentes');
        container.innerHTML = data.length === 0 ? "<p style='color:#94a3b8; font-size:0.9em;'>N√£o h√° volumes aguardando retirada.</p>" : "";
        data.forEach(item => {
            container.innerHTML += `
                <div class="item-pendente">
                    <div>
                        <span style="font-weight:800; color:var(--navy)">${item.moradores.bloco}-${item.moradores.apartamento}</span><br>
                        <small style="color:#64748b">${item.moradores.nome} (${item.quantidade} vol)</small>
                    </div>
                    <button class="btn-baixa" onclick="darBaixa('${item.id}')">BAIXA MANUAL</button>
                </div>`;
        });
    }

    async function registrar() {
        const id = document.getElementById('apartamento').value;
        const qtd = document.getElementById('qtd').value;
        if(!id) return alert("Selecione o morador antes de protocolar!");
        
        const { data, error } = await supabaseClient.from('encomendas').insert([{ morador_id: id, quantidade: qtd }]).select();
        
        if(!error) {
            const m = window.moradoresGlobal.find(mor => mor.id == id);
            const link = `${window.location.origin}${window.location.pathname}?id=${data[0].id}`;
            const msg = window.encodeURIComponent(`üì¶ *CONDOM√çNIO √ÅGUA MARINHA*\n\nOl√° *${m.nome}*,\nInformamos que chegou *${qtd} volume(s)* para sua unidade.\n\nRetire na portaria e confirme no link abaixo:\nüëâ ${link}`);
            window.open(`https://wa.me/${m.whatsapp}?text=${msg}`, '_blank');
            location.reload();
        } else {
            alert("Erro ao registrar no banco de dados.");
        }
    }

    async function darBaixa(id) {
        if(confirm("Deseja realizar a baixa manual desta entrega?")) {
            await supabaseClient.from('encomendas').update({ status: 'ENTREGUE' }).eq('id', id);
            location.reload();
        }
    }

    async function exportarDados() {
        const { data } = await supabaseClient.from('encomendas').select('status, quantidade, criado_em, moradores(nome, bloco, apartamento)');
        let csv = "Data;Bloco;Apto;Nome;Qtd;Status\n";
        data.forEach(row => {
            csv += `${new Date(row.criado_em).toLocaleDateString()};${row.moradores.bloco};${row.moradores.apartamento};${row.moradores.nome};${row.quantidade};${row.status}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `relatorio_agua_marinha_${new Date().toLocaleDateString()}.csv`;
        a.click();
    }

    inicializar();
</script>
</body>
</html>
