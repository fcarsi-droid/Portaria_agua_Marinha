<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portaria √Ågua Marinha</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --navy: #1e293b; --navy-dark: #0f172a; --blue-action: #00b4d8; --green-success: #22c55e; --bg-gray: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-gray); padding: 15px; display: flex; flex-direction: column; align-items: center; color: #334155; }
        .card { background: white; border: 2px solid #e2e8f0; padding: 24px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); width: 100%; max-width: 450px; margin-bottom: 20px; }
        h1 { text-transform: uppercase; font-weight: 800; margin-top: 0; color: var(--navy); font-style: italic; }
        label { display: block; margin-top: 15px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b; }
        select, input { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; }
        .btn-principal { width: 100%; background-color: var(--navy); color: white; padding: 18px; margin-top: 25px; border: none; border-bottom: 4px solid #020617; border-radius: 12px; font-weight: 800; text-transform: uppercase; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-principal:active { border-bottom-width: 0; transform: translateY(4px); }
        .item-pendente { border-bottom: 1px solid #f1f5f9; padding: 12px 0; display: flex; justify-content: space-between; align-items: center; }
        .btn-baixa { background: var(--green-success); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen" class="card hidden">
        <h1>Acesso Restrito</h1>
        <p>Digite a senha da portaria:</p>
        <input type="password" id="senha-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <button class="btn-principal" onclick="verificarSenha()">Entrar no Sistema</button>
    </div>

    <div id="visao-morador" class="card hidden">
        <h1>Confirmar Retirada</h1>
        <p id="detalhe-encomenda">Buscando detalhes...</p>
        <button id="btn-confirmar" class="btn-principal" style="background: var(--green-success);" onclick="confirmarPeloMorador()">üì¶ CONFIRMAR RECEBIMENTO</button>
    </div>

    <div id="visao-porteiro" class="hidden">
        <div class="card">
            <h1>üì¶ Registro de Entrada</h1>
            <label>Bloco</label>
            <select id="bloco" onchange="filtrarApartamentos()"><option value="">Carregando...</option></select>
            <label>Apartamento / Morador</label>
            <select id="apartamento"><option value="">Selecione o Bloco...</option></select>
            <label>Volumes</label>
            <input type="number" id="qtd" value="1" min="1">
            <button class="btn-principal" onclick="registrar()">CONFIRMAR REGISTRO E ENVIAR ALERTA</button>
        </div>

        <div class="card">
            <h2>üöö Aguardando Retirada</h2>
            <div id="lista-pendentes">Carregando...</div>
            <button class="btn-principal" style="background: var(--blue-action);" onclick="exportarDados()">üìä Gerar Relat√≥rio CSV</button>
            <button class="btn-principal" style="background: #94a3b8;" onclick="logout()">Sair do Sistema</button>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://esegzalccqvoypdpencs.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_kuJIAQ5crRqZlNO5spRdJQ__G9QLrjI';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // SENHA DIRETA PARA N√ÉO DAR ERRO
    const SENHA_CORRETA = "RDEAM2026#";

    const urlParams = new URLSearchParams(window.location.search);
    const encomendaId = urlParams.get('id');

    function inicializar() {
        if (encomendaId) {
            exibirVisaoMorador();
        } else {
            if (localStorage.getItem('portaria_logado') === 'true') {
                exibirVisaoPorteiro();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }
    }

    function verificarSenha() {
        const input = document.getElementById('senha-input').value.trim();
        if (input === SENHA_CORRETA) {
            localStorage.setItem('portaria_logado', 'true');
            location.reload();
        } else {
            alert("Senha Incorreta!");
        }
    }

    function logout() {
        localStorage.removeItem('portaria_logado');
        location.reload();
    }

    async function exibirVisaoPorteiro() {
        document.getElementById('visao-porteiro').classList.remove('hidden');
        const { data } = await supabaseClient.from('moradores').select('*').order('bloco').order('apartamento');
        window.moradoresGlobal = data;
        const blocos = [...new Set(data.map(m => m.bloco))];
        const select = document.getElementById('bloco');
        select.innerHTML = '<option value="">Bloco</option>';
        blocos.forEach(b => select.innerHTML += `<option value="${b}">${b}</option>`);
        carregarPendencias();
    }

    function filtrarApartamentos() {
        const bloco = document.getElementById('bloco').value;
        const select = document.getElementById('apartamento');
        select.innerHTML = '<option value="">Apartamento</option>';
        window.moradoresGlobal.filter(m => m.bloco === bloco).forEach(m => {
            select.innerHTML += `<option value="${m.id}">${m.apartamento} - ${m.nome}</option>`;
        });
    }

    async function carregarPendencias() {
        const { data } = await supabaseClient.from('encomendas').select('id, quantidade, moradores(nome, bloco, apartamento)').eq('status', 'DISPON√çVEL');
        const container = document.getElementById('lista-pendentes');
        container.innerHTML = data.length === 0 ? "Tudo entregue!" : "";
        data.forEach(item => {
            container.innerHTML += `<div class="item-pendente"><div><b>${item.moradores.bloco}-${item.moradores.apartamento}</b><br><small>${item.moradores.nome}</small></div><button class="btn-baixa" onclick="darBaixa('${item.id}')">BAIXA</button></div>`;
        });
    }

    async function registrar() {
        const id = document.getElementById('apartamento').value;
        const qtd = document.getElementById('qtd').value;
        if(!id) return alert("Selecione o morador!");
        const { data, error } = await supabaseClient.from('encomendas').insert([{ morador_id: id, quantidade: qtd }]).select();
        if(!error) {
            const m = window.moradoresGlobal.find(mor => mor.id == id);
            const link = `${window.location.origin}${window.location.pathname}?id=${data[0].id}`;
            const msg = window.encodeURIComponent(`üì¶ *PORTARIA:* Ol√° ${m.nome}, chegou sua encomenda (${qtd} vol).\nConfirme a retirada: ${link}`);
            window.open(`https://wa.me/${m.whatsapp}?text=${msg}`, '_blank');
            location.reload();
        }
    }

    async function darBaixa(id) {
        if(confirm("Baixa manual?")) {
            await supabaseClient.from('encomendas').update({ status: 'ENTREGUE' }).eq('id', id);
            location.reload();
        }
    }

    async function exibirVisaoMorador() {
        document.getElementById('visao-morador').classList.remove('hidden');
        const { data } = await supabaseClient.from('encomendas').select('quantidade, status, moradores(nome, bloco, apartamento)').eq('id', encomendaId).single();
        if (data) {
            if (data.status === 'ENTREGUE') {
                document.getElementById('visao-morador').innerHTML = "<h1>‚úÖ J√° Entregue</h1>";
            } else {
                document.getElementById('detalhe-encomenda').innerText = `${data.moradores.nome}, confirme a retirada de ${data.quantidade} volume(s).`;
            }
        }
    }

    async function confirmarPeloMorador() {
        await supabaseClient.from('encomendas').update({ status: 'ENTREGUE' }).eq('id', encomendaId);
        location.reload();
    }

    function exportarDados() { /* L√≥gica de CSV igual ao anterior */ }

    inicializar();
</script>
</body>
</html>
