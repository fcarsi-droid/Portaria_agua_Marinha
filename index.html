<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portaria √Ågua Marinha</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --yellow: #ffb703; --pink: #fb8500; --blue: #00b4d8; }
        body { font-family: 'Arial Black', sans-serif; background-color: #f0f0f0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; border: 4px solid black; padding: 20px; box-shadow: 8px 8px 0px black; width: 100%; max-width: 450px; margin-bottom: 30px; }
        h1, h2 { text-transform: uppercase; border-bottom: 4px solid black; padding-bottom: 5px; margin-top: 0; }
        label { display: block; margin-top: 15px; font-size: 0.7em; text-transform: uppercase; }
        select, input, button { width: 100%; padding: 12px; margin-top: 5px; border: 3px solid black; font-weight: bold; box-sizing: border-box; }
        button { background-color: var(--yellow); cursor: pointer; text-transform: uppercase; }
        button:hover { background-color: var(--pink); transform: translate(-2px, -2px); box-shadow: 4px 4px 0px black; }
        .item-pendente { border: 2px solid black; padding: 10px; margin-top: 10px; background: #fff; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .btn-baixa { width: auto; margin: 0; padding: 5px 10px; background: #90be6d; font-size: 0.7em; }
        .btn-relatorio { background: var(--blue); margin-top: 10px; color: white; }
    </style>
</head>
<body>

    <div class="card">
        <h1>üì¶ Registrar Entrada</h1>
        <label>Bloco</label>
        <select id="bloco" onchange="filtrarApartamentos()"><option>Carregando...</option></select>
        <label>Apartamento</label>
        <select id="apartamento"><option>Selecione o Bloco...</option></select>
        <label>Volumes</label>
        <input type="number" id="qtd" value="1" min="1">
        <button onclick="registrar()">Salvar e Avisar no Whats</button>
    </div>

    <div class="card">
        <h2>üöö Aguardando Retirada</h2>
        <div id="lista-pendentes">Carregando pend√™ncias...</div>
        <button class="btn-relatorio" onclick="exportarDados()">üìä Exportar Relat√≥rio (CSV)</button>
    </div>

<script>
    const SUPABASE_URL = 'https://esegzalccqvoypdpencs.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_kuJIAQ5crRqZlNO5spRdJQ__G9QLrjI';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let moradoresGlobal = [];

    async function inicializar() {
        await carregarMoradores();
        await carregarPendencias();
    }

    async function carregarMoradores() {
        const { data } = await supabaseClient.from('moradores').select('*').order('bloco').order('apartamento');
        moradoresGlobal = data;
        const blocos = [...new Set(data.map(m => m.bloco))];
        const select = document.getElementById('bloco');
        select.innerHTML = '<option value="">Selecione o Bloco</option>';
        blocos.forEach(b => select.innerHTML += `<option value="${b}">Bloco ${b}</option>`);
    }

    function filtrarApartamentos() {
        const bloco = document.getElementById('bloco').value;
        const select = document.getElementById('apartamento');
        select.innerHTML = '<option value="">Selecione o Apartamento</option>';
        moradoresGlobal.filter(m => m.bloco === bloco).forEach(m => {
            select.innerHTML += `<option value="${m.id}">${m.apartamento} - ${m.nome}</option>`;
        });
    }

    async function carregarPendencias() {
        const { data, error } = await supabaseClient.from('encomendas')
            .select('id, quantidade, criado_em, moradores(nome, bloco, apartamento, whatsapp)')
            .eq('status', 'DISPON√çVEL').order('criado_em', { ascending: false });
        
        const container = document.getElementById('lista-pendentes');
        container.innerHTML = data.length === 0 ? "Nenhuma encomenda pendente." : "";
        data.forEach(item => {
            container.innerHTML += `
                <div class="item-pendente">
                    <div>
                        <b>${item.moradores.bloco}-${item.moradores.apartamento}</b><br>
                        <small>${item.quantidade} vol. em ${new Date(item.criado_em).toLocaleDateString()}</small>
                    </div>
                    <button class="btn-baixa" onclick="darBaixa(${item.id})">RETIRADO</button>
                </div>`;
        });
    }

    async function registrar() {
        const id = document.getElementById('apartamento').value;
        const qtd = document.getElementById('qtd').value;
        if(!id) return alert("Selecione o morador!");

        const { error } = await supabaseClient.from('encomendas').insert([{ morador_id: id, quantidade: qtd }]);
        if(!error) {
            const m = moradoresGlobal.find(mor => mor.id == id);
            const msg = window.encodeURIComponent(`üì¶ *PORTARIA:* Ol√° ${m.nome}, chegou ${qtd} volume(s) para voc√™.`);
            window.open(`https://wa.me/${m.whatsapp}?text=${msg}`, '_blank');
            location.reload();
        }
    }

    async function darBaixa(id) {
        if(confirm("Confirmar que a encomenda foi retirada?")) {
            await supabaseClient.from('encomendas').update({ status: 'ENTREGUE' }).eq('id', id);
            location.reload();
        }
    }

    async function exportarDados() {
        const { data } = await supabaseClient.from('encomendas').select('status, quantidade, criado_em, moradores(nome, bloco, apartamento)');
        let csv = "Data;Bloco;Apto;Nome;Qtd;Status\n";
        data.forEach(row => {
            csv += `${new Date(row.criado_em).toLocaleDateString()};${row.moradores.bloco};${row.moradores.apartamento};${row.moradores.nome};${row.quantidade};${row.status}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', 'relatorio_encomendas.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    inicializar();
</script>
</body>
</html>
