<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portaria √Ågua Marinha</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --yellow: #ffb703; --pink: #fb8500; --blue: #00b4d8; --green: #90be6d; }
        body { font-family: 'Arial Black', sans-serif; background-color: #f0f0f0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .card { background: white; border: 4px solid black; padding: 20px; box-shadow: 8px 8px 0px black; width: 100%; max-width: 450px; margin-bottom: 30px; }
        h1, h2 { text-transform: uppercase; border-bottom: 4px solid black; padding-bottom: 5px; margin-top: 0; }
        label { display: block; margin-top: 15px; font-size: 0.7em; text-transform: uppercase; }
        select, input, button { width: 100%; padding: 12px; margin-top: 5px; border: 3px solid black; font-weight: bold; box-sizing: border-box; }
        button { background-color: var(--yellow); cursor: pointer; text-transform: uppercase; }
        button:hover { background-color: var(--pink); transform: translate(-2px, -2px); box-shadow: 4px 4px 0px black; }
        .item-pendente { border: 2px solid black; padding: 10px; margin-top: 10px; background: #fff; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .btn-baixa { width: auto; margin: 0; padding: 5px 10px; background: var(--green); font-size: 0.7em; }
        .hidden { display: none !important; }
        #login-screen { text-align: center; }
    </style>
</head>
<body>

    <div id="login-screen" class="card hidden">
        <h1>Acesso Restrito</h1>
        <p>Digite a senha da portaria:</p>
        <input type="password" id="senha-input" placeholder="****">
        <button onclick="verificarSenha()">Entrar no Sistema</button>
    </div>

    <div id="visao-morador" class="card hidden">
        <h1 id="titulo-morador">Confirmar Retirada</h1>
        <p id="detalhe-encomenda">Buscando detalhes...</p>
        <button id="btn-confirmar" style="background: var(--green); height: 80px;" onclick="confirmarPeloMorador()">üì¶ CONFIRMAR RECEBIMENTO</button>
    </div>

    <div id="visao-porteiro" class="hidden">
        <div class="card">
            <h1>üì¶ Registrar Entrada</h1>
            <label>Bloco</label>
            <select id="bloco" onchange="filtrarApartamentos()"><option>Carregando...</option></select>
            <label>Apartamento</label>
            <select id="apartamento"><option>Selecione o Bloco...</option></select>
            <label>Volumes</label>
            <input type="number" id="qtd" value="1" min="1">
            <button onclick="registrar()">Salvar e Avisar no Whats</button>
        </div>

        <div class="card">
            <h2>üöö Aguardando Retirada</h2>
            <div id="lista-pendentes">Carregando...</div>
            <button style="background: var(--blue); margin-top: 20px;" onclick="exportarDados()">üìä Gerar Relat√≥rio CSV</button>
            <button style="background: #ccc; margin-top: 10px; font-size: 0.6em;" onclick="logout()">Sair / Bloquear</button>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://esegzalccqvoypdpencs.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_kuJIAQ5crRqZlNO5spRdJQ__G9QLrjI';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- DEFINA SUA SENHA AQUI ---
    const SENHA_MESTRA = "1234"; // Mude para a senha que desejar
    // ----------------------------

    const urlParams = new URLSearchParams(window.location.search);
    const encomendaId = urlParams.get('id');

    async function inicializar() {
        if (encomendaId) {
            exibirVisaoMorador();
        } else {
            verificarSessao();
        }
    }

    function verificarSessao() {
        if (localStorage.getItem('portaria_logado') === 'true') {
            exibirVisaoPorteiro();
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
        }
    }

    function verificarSenha() {
        const input = document.getElementById('senha-input').value;
        if (input === SENHA_MESTRA) {
            localStorage.setItem('portaria_logado', 'true');
            location.reload();
        } else {
            alert("Senha incorreta!");
        }
    }

    function logout() {
        localStorage.removeItem('portaria_logado');
        location.reload();
    }

    async function exibirVisaoPorteiro() {
        document.getElementById('visao-porteiro').classList.remove('hidden');
        await carregarMoradores();
        await carregarPendencias();
    }

    async function exibirVisaoMorador() {
        document.getElementById('visao-morador').classList.remove('hidden');
        const { data } = await supabaseClient.from('encomendas').select('quantidade, status, moradores(nome, bloco, apartamento)').eq('id', encomendaId).single();
        
        if (data) {
            if (data.status === 'ENTREGUE') {
                document.getElementById('visao-morador').innerHTML = "<h1>‚úÖ J√° Entregue</h1><p>Esta encomenda j√° consta como retirada.</p>";
            } else {
                document.getElementById('detalhe-encomenda').innerText = `${data.moradores.nome}, confirme a retirada de ${data.quantidade} volume(s) - Bloco ${data.moradores.bloco} Apt ${data.moradores.apartamento}.`;
            }
        }
    }

    async function confirmarPeloMorador() {
        const { error } = await supabaseClient.from('encomendas').update({ status: 'ENTREGUE' }).eq('id', encomendaId);
        if (!error) {
            document.getElementById('visao-morador').innerHTML = "<h1 style='color:var(--green)'>‚úÖ SUCESSO!</h1><p>Sua retirada foi registrada. Obrigado!</p>";
        }
    }

    async function carregarMoradores() {
        const { data } = await supabaseClient.from('moradores').select('*').order('bloco').order('apartamento');
        window.moradoresGlobal = data;
        const blocos = [...new Set(data.map(m => m.bloco))];
        const select = document.getElementById('bloco');
        select.innerHTML = '<option value="">Bloco</option>';
        blocos.forEach(b => select.innerHTML += `<option value="${b}">${b}</option>`);
    }

    function filtrarApartamentos() {
        const bloco = document.getElementById('bloco').value;
        const select = document.getElementById('apartamento');
        select.innerHTML = '<option value="">Apartamento</option>';
        window.moradoresGlobal.filter(m => m.bloco === bloco).forEach(m => {
            select.innerHTML += `<option value="${m.id}">${m.apartamento} - ${m.nome}</option>`;
        });
    }

    async function carregarPendencias() {
        const { data } = await supabaseClient.from('encomendas').select('id, quantidade, criado_em, moradores(nome, bloco, apartamento)').eq('status', 'DISPON√çVEL').order('criado_em', { ascending: false });
        const container = document.getElementById('lista-pendentes');
        container.innerHTML = data.length === 0 ? "Tudo entregue!" : "";
        data.forEach(item => {
            container.innerHTML += `<div class="item-pendente"><div><b>${item.moradores.bloco}-${item.moradores.apartamento}</b><br><small>${item.moradores.nome}</small></div><button class="btn-baixa" onclick="darBaixa(${item.id})">BAIXA</button></div>`;
        });
    }

    async function registrar() {
        const id = document.getElementById('apartamento').value;
        const qtd = document.getElementById('qtd').value;
        if(!id) return alert("Selecione o morador!");
        const { data, error } = await supabaseClient.from('encomendas').insert([{ morador_id: id, quantidade: qtd }]).select();
        if(!error) {
            const m = window.moradoresGlobal.find(mor => mor.id == id);
            const link = `${window.location.origin}${window.location.pathname}?id=${data[0].id}`;
            const msg = window.encodeURIComponent(`üì¶ *PORTARIA:* Ol√° ${m.nome}, chegou sua encomenda.\nConfirme a retirada aqui: ${link}`);
            window.open(`https://wa.me/${m.whatsapp}?text=${msg}`, '_blank');
            location.reload();
        }
    }

    async function darBaixa(id) {
        if(confirm("Confirmar entrega manual?")) {
            await supabaseClient.from('encomendas').update({ status: 'ENTREGUE' }).eq('id', id);
            location.reload();
        }
    }

    async function exportarDados() {
        const { data } = await supabaseClient.from('encomendas').select('status, quantidade, criado_em, moradores(nome, bloco, apartamento)');
        let csv = "Data;Bloco;Apto;Nome;Qtd;Status\n";
        data.forEach(row => {
            csv += `${new Date(row.criado_em).toLocaleDateString()};${row.moradores.bloco};${row.moradores.apartamento};${row.moradores.nome};${row.quantidade};${row.status}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'relatorio.csv';
        a.click();
    }

    inicializar();
</script>
</body>
</html>
